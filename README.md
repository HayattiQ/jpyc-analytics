# JPYC Analytics 仕様書

## 1. 概要
- JPYC のオンチェーン流動性・トランザクションを可視化する分析ポータル。
- 投資家、コミュニティが同じデータを参照できる単一ページダッシュボード（SPA）を提供。
- React + Recharts を採用し、Web ブラウザのみでアクセス可能なレスポンシブ UI。

## 2. 目的
1. JPYC の健全性（時価総額、流通量、担保状況）をリアルタイムで把握。
2. チェーン別の利用状況と需給バランスを解説し、意思決定を支援。
3. 異常値検知・アラートで早期リスク対応を可能にする。
4. 認証なしで誰でも閲覧できる公開分析ダッシュボードを提供。

## 3. 想定ユーザー
- パートナー取引所・DeFi プロトコル
- コミュニティアナリスト／研究者
- 一般ホルダー
- トレーダー

## 4. 成果指標 (KPIs)
- 日次アクティブユーザー数 / 滞在時間
- チェーン切替やフィルタ利用回数（機能ごとの関心度）
- 横棒グラフやヒストリカルチャートのロード成功率 / レイテンシ
- API レスポンス遅延（目標 5 分以内にオンチェーン変化を反映）
- 公開ダッシュボードの可用性 (SLO 99.5%)

## 5. データソース
| ソース | 内容 | 更新頻度 | 備考 |
|--------|------|----------|------|
| JPYC 発行コントラクト | 総発行量、バーン量、リザーブ | 5 分 | 直接 RPC 読み取り（M0） |
| The Graph Subgraph (チェーン別) | 発行量ヒストリー、TVL | 1 分〜5 分 | M1 以降で利用 |
| DEX / AMM API | 価格・板情報・流動性 | 5 分 | AMM ごとに REST / GraphQL |
| Config ファイル | サービス / プロトコル定義 | 手動更新 | JSON/YAML 管理。DB は使用しない |

## 6. コア機能
1. **トップダッシュボード**: 総発行量、循環供給、担保率、価格指標、チェーン別比率をカード表示（すべて単一ページ内にセクション化）。
2. **チェーン別ビュー**: 同一ページ内のパネルでチェーン選択、TVL、取引件数、独自アドレス数を表示。ヒートマップと時系列チャートをタブ切替。
3. **トランザクションエクスプローラ**: セクション内でデータグリッドを表示し、フィルタ UI は折りたたみ。エンティティタグ付け済みのトランザクション一覧 + 高度フィルタ（期間、トークン、相手先カテゴリ）。
4. **プールヘルス監視**: 主な AMM プールの深さ、スリッページ、手数料 APR をカード + チャートで単一ページに配置。
5. **アラート & レポート**: 閾値ベース + 異常検知 (z-score) で通知（メール / Discord / Webhook）。週次レポート PDF/CSV 出力リンクを同ページ内に設置。

## 7. 画面要件
- **単一ページ構成**: SPA 内にセクションアンカーを配置し、グローバルナビはページ内スクロール。ロゴ、Dashboard、Chains、Explorer、Alerts、Docs、言語切替 (JA/EN)。
- **ヒーローセクション**: KPI カード (4〜6) + チェーン構成ドーナツチャート。
- **チャート群**: 時系列 (発行量、TVL)、棒グラフ (取引件数)、表形式 (トップアドレス)。
- **細部要件**
  - チャートは Recharts を使用し、ツールチップ、ズーム、エクスポート (PNG/SVG/CSV) に対応。
  - ダーク / ライトテーマ切替。
  - Table: 無限スクロール + カラムカスタマイズ + CSV エクスポート。

## 8. インタラクション / UX
- デフォルト期間: 過去 30 日、クイック切替 (24h / 7d / 30d / YTD)。
- パネルはドラッグ & ドロップで並び替え、ユーザーごとにレイアウト保存。
- 重要 KPI 変化率はバッジ色 (グリーン/レッド) + アップダウンアイコン表示。
- ローディング時はスケルトン、データエラー時は再取得ボタンを表示。

## 9. 技術要件
- **データ取り込み**: M0 は各チェーンのコントラクトから直接 RPC 読み取り。M1 以降は The Graph Subgraph を主要ソースとし、必要に応じて AMM API から板情報を pull。チェーン / サービスの登録は config ファイル (JSON/YAML) で管理し、DB は使用しない。
- **フロントエンド**: Vite + pure React 18, TypeScript, Tailwind CSS, Recharts を利用。SSR は行わず SPA として配信し、Zustand で状態管理。
- **バックエンド**: 必要最小限の Node.js (Fastify) プロキシで Subgraph / RPC へのアクセスとキャッシュを制御。永続データベースは持たず、短期キャッシュのみ（in-memory / CDN）。
- **データ管理**: 永続ストレージや RDBMS は使わず、config ファイルと外部データソースの組み合わせで構成。設定ファイルは Git 管理。
- **CI/CD**: GitHub Actions + Terraform(or Pulumi) で IaC。main へのマージで自動デプロイ。
- **監視**: OpenTelemetry + Grafana + PagerDuty、SLO 99.5%。

## 10. データ更新フロー
1. The Graph 側の Subgraph がチェーン上のイベントを継続的にインデックス化し、JPYC 発行量や TVL を常時更新（M1 以降の主データ源）。
2. フロントエンド（または Node プロキシ）が Subgraph API を直接クエリし、レスポンスをクライアントキャッシュ / CDN で短期保存するのみ。独自スケジューラやバッチ処理は行わない。
3. M0 で必要な各チェーン供給量は、フロントエンドから RPC 読み取り or プロキシ経由で取得し、Subgraph 移行後もフォールバックとして維持。
4. Subgraph 側で遅延/失敗が発生した場合はリトライし、それでも取得できない場合のみ監視通知（Slack / PagerDuty）を送る。

## 11. セキュリティ / 権限
- 認証レスで誰でも閲覧可能。書き込み機能は提供しないためロール制御は不要。
- Subgraph / RPC へアクセスする Node プロキシは API キー + IP 制限で保護し、レートリミットを実装。

## 12. パフォーマンス / アクセシビリティ
- TTFB < 200ms (キャッシュヒット時)、初回ロード 2 秒以内を目標。
- P95 インタラクション応答 < 250ms。
- WCAG 2.1 AA 準拠（コントラスト比、キーボード操作、スクリーンリーダー対応）。

## 13. 将来拡張
- ガバナンス投票やオンチェーンガバナンス指標の統合。
- ペグ安定性指数やボラティリティなどのリスク指標可視化。

## 14. マイルストーン
| フェーズ | 内容 | 期間 |
|----------|------|------|
| M0 | コントラクトから直接 read した各チェーンごとの供給量を取得し、横棒グラフで表示するシングルページ MVP | 2 週間 |
| M1 | Subgraph を用いてチェーン別発行量と総発行量のヒストリカルグラフを実装 | 6 週間 |
| M2 | 各プロトコルごとの流動性量と AMM 板情報を取得し、JPYC/USDC 現在価格とともに表示 | 8 週間 |
| M3 | サービス指定を config ファイルで管理し、各サービスごとの JPYC 流通量と TVL を表示 | 6 週間 |
| 継続 | 最適化 | 随時 |

## 15. 未決事項
- 利用する Subgraph のスキーマ定義と、チェーンごとのエンドポイント確定。
- Config ファイルの構造（JSON / YAML）とデプロイプロセスでの管理方法。
- AMM / Orderbook API の優先プロトコル選定とレート制限ハンドリング。
- 公開 API のキャッシュ戦略（CDN / Edge）と更新間隔。
